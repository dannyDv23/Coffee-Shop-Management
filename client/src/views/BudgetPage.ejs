<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Budget Management</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    .highlight-profit {
      font-weight: bold;
    }

    .highlight-profit .amount-red {
      color: red;
    }

    .highlight-profit .amount-green {
      color: green;
    }

    .total-expense {
      font-weight: bold;
      text-align: right;
      margin-top: 10px;
    }
    .title {
      text-align: center; /* Căn giữa tiêu đề */
      font-weight: bold;  /* In đậm */
      font-size: 2.5rem;    /* Tăng kích thước font */
      margin-top: 20px;
      margin-bottom: 10px;
      color: #362c5f;
    }
  
  </style>
</head>
<body>
  <div class="page-inner">
    <div class="row">
      <div class="col-md-12">
        <div>
          <div class="card-header">
            <div class="title">Budget Management</div>
            <div class="col-md-12">
              <div class="card">
                <div class="card-header">
                  <div class="card-title">Budget Summary</div>
                  <hr>
                  <div class="date-picker">
                    <label for="startDate">Start Date:</label>
                    <input type="date" id="startDate" name="startDate">
                    <label for="endDate">End Date:</label>
                    <input type="date" id="endDate" name="endDate">
                    <button onclick="fetchData()">Apply</button>
                  </div>
                  
                </div>
                
                <div class="card-body">
                  <table id="reportTable" class="table table-striped">
                    <thead>
                      <tr>
                        <th>Category</th>
                        <th>Amount</th>
                      </tr>
                    </thead>
                    <tbody></tbody>
                  </table>
                </div>
              </div>
            </div>
            <div class="col-md-12">
              <div class="card">
                <div class="card-header">
                  <div class="card-title">Other Cost History</div>
                </div>
                <div class="card-body">
                  <table id="expenseTable" class="table table-striped">
                    <thead>
                      <tr>
                        <th>Name</th>
                        <th>Price</th>
                        <th>Date</th>
                      </tr>
                    </thead>
                    <tbody></tbody>
                  </table>
                  <div id="totalExpense" class="total-expense"></div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      fetchExpenseHistory();
    });

    async function fetchData() {
      const startDate = document.getElementById('startDate').value;
      const endDate = document.getElementById('endDate').value;
      const today = new Date().toISOString().split('T')[0];

      if (!startDate || !endDate) {
        alert('Please select a start and end date');
        return;
      }
      if (endDate > today || endDate < startDate) {
        alert('Invalid date range');
        return;
      }

      fetchBudgetTableData(startDate, endDate);
    }

    async function fetchBudgetTableData(startDate, endDate) {
      try {
        const response = await fetch(`http://127.0.0.1:3000/api/budget/budget-table?startDate=${startDate}&endDate=${endDate}`);
        if (!response.ok) throw new Error('Failed to fetch budget table data');
        const data = await response.json();
        populateTable(data, 'reportTable');
      } catch (error) {
        console.error(error);
      }
    }

    async function fetchExpenseHistory() {
      try {
        const response = await fetch('http://127.0.0.1:3000/api/budget/expense-history');
        if (!response.ok) throw new Error('Failed to fetch expense history');
        const data = await response.json();
        populateTable(data, 'expenseTable', true);
        displayTotalExpense(data);
      } catch (error) {
        console.error(error);
      }
    }

    function populateTable(data, tableId, isExpense = false) {
      const tableBody = document.querySelector(`#${tableId} tbody`);
      tableBody.innerHTML = '';

      data.forEach(row => {
        const tableRow = document.createElement('tr');
        if (isExpense) {
          const nameCell = document.createElement('td');
          const priceCell = document.createElement('td');
          const dateCell = document.createElement('td');
          nameCell.textContent = row.name;
          priceCell.textContent = row.money.toLocaleString('en-US');
          dateCell.textContent = new Date(row.date).toLocaleDateString();
          tableRow.append(nameCell, priceCell, dateCell);
        } else {
          const categoryCell = document.createElement('td');
          const amountCell = document.createElement('td');
          categoryCell.textContent = row.category;
          amountCell.textContent = row.amount.toLocaleString('en-US');
          if (row.highlight) {
            tableRow.classList.add('highlight-profit');
            amountCell.classList.add(row.color === 'red' ? 'amount-red' : 'amount-green');
          }
          tableRow.append(categoryCell, amountCell);
        }
        tableBody.appendChild(tableRow);
      });
    }

    function displayTotalExpense(expenses) {
      const totalExpense = expenses.reduce((sum, expense) => sum + expense.money, 0);
      const totalExpenseDiv = document.getElementById('totalExpense');
      totalExpenseDiv.textContent = `Total Expense: ${totalExpense.toLocaleString('en-US')} VND`;
    }
  </script>
</body>
</html>
